#!/bin/bash

# Configuration file for ufw-blocklist scripts. This file should be placed at /etc/default/ufw-blocklist

# --- General Settings ---
# Finding logger command path
UFBL_LOGGER_BIN="$(command -v logger)"
if [ -z "$UFBL_LOGGER_BIN" ]; then
    # Use echo to stderr as logger if not available
    echo "Error: logger command not found. Logging will be disabled for ufw-blocklist scripts." >&2
    # Set UFBL_LOGGER_CMD to a dummy command ":" (no-op)
    UFBL_LOGGER_CMD=":"
else
    # logger command prefix using the found path
    UFBL_LOGGER_CMD="$UFBL_LOGGER_BIN -t ufw-blocklist"
fi

# Finding ipset executable path
UFBL_IPSET_BIN="$(command -v ipset)"
if [ -z "$UFBL_IPSET_BIN" ]; then
    # Use logger if available, otherwise echo to stderr
    if [ -n "$UFBL_LOGGER_BIN" ]; then
        "$UFBL_LOGGER_BIN" -s -t ufw-blocklist "Error: ipset command not found. Please install ipset."
    else
        echo "Error: ipset command not found. Please install ipset." >&2
    fi
    # exit 1 # Uncomment this line if you want sourcing the config to fail hard if ipset is missing
fi

# --- Whitelist Settings ---
# ipset name for the whitelist
UFBL_WHITELIST_IPSET_NAME="ufw-whitelist"
# File containing IP addresses/CIDRs to always allow, one per line
UFBL_WHITELIST_FILE="/etc/ufw/ufw-whitelist.txt"
# Headroom for maxelem for the whitelist ipset
UFBL_WHITELIST_MAXELEM_HEADROOM=128

# --- Blocklist Definitions ---
# Define multiple blocklists using indexed variables.
# Each blocklist needs:
# - UFBL_IPSET_NAME<Index>: Name of the ipset
# - UFBL_SEED_FILE<Index>: Path to the initial seed file (for after.init.d)
# - UFBL_MAXELEM_HEADROOM<Index>: Headroom for maxelem (optional)
# - UFBL_URL<Index>: URL for updates (for cron scripts)
# - UFBL_MIN_ENTRIES<Index>: Minimum expected entries from URL (for cron scripts)
# - UFBL_WARN_ON_NO_CHANGE<Index>: Warn on no change (yes/no) (for cron scripts)

# Default headroom for maxelem if not specified for a specific blocklists
UFBL_DEFAULT_MAXELEM_HEADROOM=128

# --- Blocklist 1 Settings ---
UFBL_IPSET_NAME1="ufw-blocklist-ipsum"
UFBL_SEED_FILE1="/etc/ufw/ufw-blocklist1.txt"
# UFBL_MAXELEM_HEADROOM1=... # UFBL_DEFAULT_MAXELEM_HEADROOM will be used if commented out
UFBL_URL1='https://raw.githubusercontent.com/stamparm/ipsum/master/levels/3.txt'
UFBL_MIN_ENTRIES1=1000
UFBL_WARN_ON_NO_CHANGE1="yes"

# --- Blocklist 2 Settings Example ---
# UFBL_IPSET_NAME2="ufw-blocklist-another"
# UFBL_SEED_FILE2="/etc/anotherlist.txt"
# UFBL_MAXELEM_HEADROOM2=256 # Overriding headroom example
# UFBL_URL2='http://example.com/anotherlist.txt'
# UFBL_MIN_ENTRIES2=500
# UFBL_WARN_ON_NO_CHANGE2="no"

# --- CIDR Validation Regex ---
# Regex to validate IPv4 CIDR notation (e.g., 192.168.1.0/24 or 10.0.0.1)
UFBL_CIDR_REGEX='^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\/(3[0-2]|[012]?[0-9]))?$'

# --- Function to check if a chain exists ---
# Usage: ufbl_chain_exists <chain_name> [table]
ufbl_chain_exists() {
    [ $# -lt 1 -o $# -gt 2 ] && {
        echo "Usage: ufbl_chain_exists <chain_name> [table]" >&2
        return 1
    }
    local chain_name="$1" ; shift
    [ $# -eq 1 ] && local table="--table $1"
    iptables $table -n --list "$chain_name" >/dev/null 2>&1
}

# --- Function to check if an set exists ---
# Usage: ufbl_set_exists <set_name>
ufbl_set_exists() {
    [ $# -ne 1 ] && {
        echo "Usage: ufbl_set_exists <set_name>" >&2
        return 1
    }
    local set_name="$1"
    "${UFBL_IPSET_BIN}" list "$set_name" -name >/dev/null 2>&1
}
