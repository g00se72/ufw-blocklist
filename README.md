# UFW Blocklist: Расширение для блокировки IP-адресов и CIDR
Данный репозиторий - это моя версия на основе репозитория от уважаемого [poddmo](https://github.com/poddmo/ufw-blocklist)

> [!WARNING]
>   
> ***Реализация сделана исключительно для себя, в научно-технических целях. Т.к. пишу и тестирую сам, то возможно мне удается проверить не все возможные сценарии использования. Если Вы решите использовать эти скрипты в своей системе, Вы делаете это полностью на свой страх и риск. Я не несу никакой ответственности за любые прямые или косвенные последствия их использования. Вся ответственность за любые результаты, проблемы или ущерб, возникшие в результате использования, ложится исключительно на Вас. Перед использованием убедительно рекомендуется внимательно изучить код и адаптировать его под свои нужды и условия***

## Описание
Проект предоставляет набор скриптов для интеграции динамических списков блокировки IP-адресов и CIDR с файрволом UFW (Uncomplicated Firewall) в Ubuntu. Используя `ipset`, скрипты позволяют эффективно блокировать большие объемы вредоносного трафика на уровне ядра.
Проект состоит из нескольких компонентов, работающих вместе для управления списками блокировки:

1. **`/etc/ufw/after.init`**: Основной скрипт, который запускается UFW после своей инициализации. Он действует как "раннер", выполняя все скрипты, расположенные в директории `/etc/ufw/after.init.d/`. Это обеспечивает модульность и позволяет легко добавлять или удалять различные списки блокировки.

2. **`/etc/ufw/after.init.d/`**: Директория, содержащая исполняемые скрипты, которые выполняются основным скриптом `after.init`. Каждый скрипт в этой директории может отвечать за инициализацию отдельного списка блокировки (`ipset`) и настройку соответствующих правил `iptables`. Скрипты именуются с числовым префиксом (например, `10-`, `20-`) для контроля порядка выполнения.

3. **`/etc/cron.daily/ufw-blocklist-*-update`**: Скрипты для ежедневного обновления списков блокировки. Они скачивают актуальные списки из внешних источников (например, из проекта [ipsum](https://github.com/stamparm/ipsum/tree/master)), валидируют их и атомарно обновляют соответствующие `ipset` без прерывания работы файрвола.

4. **`/etc/default/ufw-blocklist`**: Централизованный конфигурационный файл, содержащий общие настройки для всех скриптов проекта, такие как пути к исполняемым файлам (`ipset`), настройки журналирования, регулярные выражения для валидации CIDR и параметры по умолчанию для списков блокировки.

## Возможности

* **Эффективная блокировка:** Использование `ipset` позволяет блокировать тысячи и миллионы IP-адресов/CIDR с минимальной нагрузкой на систему.

* **Модульность:** Легкое добавление поддержки новых списков блокировки путем создания новых скриптов в `/etc/ufw/after.init.d/` и `/etc/cron.daily/`.

* **Автоматическое обновление:** Ежедневное обновление списков блокировки через cron.

* **Централизованная конфигурация:** Удобное управление основными параметрами через единый файл.

* **Надежная валидация:** Проверка записей на соответствие формату CIDR перед добавлением в `ipset`.

* **Совместимость с UFW:** Бесшовная интеграция с механизмом `after.init` файрвола UFW.

## Установка

Предполагается, что у вас уже установлен и настроен UFW, ipset.

1. Создайте бэкап оригинального `after.init` скрипта UFW
   ```bash
   sudo cp /etc/ufw/after.init /etc/ufw/after.init.orig
   ```

2. **Скопируйте файлы на свои места:**
   ```bash
   sudo mkdir -p /etc/ufw/after.init.d
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/ufw-blocklist' -o /etc/default/ufw-blocklist
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/after.init' -o /etc/ufw/after.init
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/10-ufw-blocklist-ipsum.ufw' -o /etc/ufw/after.init.d/10-ufw-blocklist-ipsum.ufw
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/ufw-blocklist-ipsum-update' -o /etc/cron.daily/ufw-blocklist-ipsum-update
   ```
   
3. **Сделайте скрипты исполняемыми:**
   ```bash
   sudo chmod +x /etc/ufw/after.init
   ```
   ```bash
   sudo chmod +x /etc/ufw/after.init.d/10-ufw-blocklist-ipsum.ufw
   ```
   ```bash
   sudo chmod +x /etc/cron.daily/ufw-blocklist-ipsum-update
   ```
   ```bash
   sudo chmod +x /etc/ufw/after.init.d/05-ufw-whitelist.ufw
   ```
   
4. **Создайте начальный файл со списком блокировки (seed file):**
   
   Скрипт `10-ufw-blocklist-ipsum.ufw` при запуске UFW пытается загрузить начальный список из файла `/etc/ufw/ufw-blocklist1.txt`. Вы можете создать этот файл вручную или скачав список командой:
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/stamparm/ipsum/master/levels/4.txt' -o /etc/ufw/ufw-blocklist1.txt
   ```
   Примечание: Убедитесь, что URL соответствует вашим потребностям. Этот файл используется только для начального заполнения `ipset` при старте UFW. Ежедневное обновление будет использовать URL, указанный в конфигурационном файле.

5. **Создайте начальный файл с белым списком:**  
   ```bash
   touch /etc/ufw/ufw-whitelist.txt
   ```
   Добавьте ваши IP/CIDR в белый список: Отредактируйте `/etc/ufw/ufw-whitelist.txt` и добавьте IP-адреса или подсети, которые вы хотите всегда разрешать.

> [!NOTE]
> Пример содержимого:\
> 192.168.1.100\
> 10.0.0.0/8\
> 203.0.113.50
   
7. **Перезапустите UFW:**
   ```bash
   sudo systemctl restart ufw
   ```
   Это запустит скрипт `/etc/ufw/after.init`, который в свою очередь запустит скрипты из `/etc/ufw/after.init.d/`, включая `10-ufw-blocklist-ipsum.ufw`. Скрипт `10-ufw-blocklist-ipsum.ufw` создаст `ipset` и добавит в него записи из `/etc/ipsum.4.txt`, а также настроит правила `iptables`.

## Конфигурация
Основной файл конфигурации находится по адресу `/etc/default/ufw-blocklist`. Вы можете редактировать его для изменения следующих параметров:
* `UFBL_IPSET_BIN`: Путь к исполняемому файлу `ipset`
* `UFBL_LOGGER_CMD`: Команда для журналирования (по умолчанию использует `logger`)
* `UFBL_DEFAULT_IPSET_NAME`: Имя `ipset` по умолчанию (используется скриптами, если не переопределено)
* `UFBL_DEFAULT_SEED_FILE`: Путь к файлу начального заполнения по умолчанию
* `UFBL_DEFAULT_MAXELEM_HEADROOM`: Дополнительное место в `ipset` сверх количества записей в списке
* `UFBL_IPSUM_URL`: URL для скачивания списка блокировки `ipsum` (используется скриптом обновления)
* `UFBL_IPSUM_MIN_ENTRIES`: Минимальное ожидаемое количество записей в списке `ipsum`
* `UFBL_IPSUM_WARN_ON_NO_CHANGE`: Включает/отключает предупреждение, если количество записей не изменилось (`yes`/`no`)
* `UFBL_CIDR_REGEX`: Регулярное выражение для валидации записей как CIDR (IPv4)

**Для добавления поддержки нового списка:**
1. Создайте новый скрипт в `/etc/ufw/after.init.d/` (например, `20-myotherlist.ufw`), который будет создавать и наполнять соответствующий `ipset` и добавлять правила `iptables`. Этот скрипт должен использовать функции и переменные из `/etc/default/ufw-blocklist`.
2. Создайте соответствующий скрипт ежедневного обновления в `/etc/cron.daily/` (например, `ufw-blocklist-myotherlist-update`), который будет скачивать и обновлять новый `ipset`.
3. При необходимости добавьте специфические параметры для нового списка в `/etc/default/ufw-blocklist` или переопределите их в скриптах нового списка.

## Использование
После установки и настройки система работает в основном автоматически. Однако вы можете использовать команды для получения статуса или сброса счетчиков:
* **Получение статуса:** Выполните команду, которая запустит скрипты `status` из `/etc/ufw/after.init.d/`. Обычно это делается через команду, связанную с UFW, или путем прямого вызова основного скрипта `after.init` (хотя прямое взаимодействие с `after.init` не всегда рекомендуется, так как он предназначен для вызова UFW).\
Более надежный способ получить статус конкретного списка (например, `ipsum`) - это посмотреть логи или использовать команды `ipset` и `iptables` напрямую, как это делает скрипт `10-ufw-blocklist-ipsum.ufw` в своем блоке `status`.

> [!NOTE]
> Пример просмотра статуса `ipset` и правил для `ipsum`:\
> `sudo ipset list ufw-blocklist-ipsum -t`\
> `sudo iptables -L -nvx | grep ufw-blocklist-ipsum`\
> `sudo journalctl -t ufw-blocklist-ipsum | tail`
> 
> Примечание: Команда `sudo /etc/ufw/after.init status` может работать, но ее основное назначение - быть вызванной UFW.

* **Сброс счетчиков (flush-all):** Чтобы сбросить счетчики пакетов в правилах `iptables` и очистить содержимое `ipset` (без его удаления), вы можете вызвать соответствующую команду. Опять же, это действие обычно инициируется через UFW или может быть выполнено вызовом скрипта в `/etc/ufw/after.init.d/` напрямую с аргументом `flush-all`.

> [!NOTE]
> Пример вызова `flush-all` для `ipsum`:\
> `sudo /etc/ufw/after.init.d/10-ufw-blocklist-ipsum.ufw flush-all`

Будьте осторожны с прямым вызовом скриптов в `after.init.d/` и основного `after.init`. Их основное предназначение - быть частью жизненного цикла UFW.

Ежедневное обновление списка `ipsum` происходит автоматически через cron. Вы можете проверить логи (`journalctl -t ufw-blocklist-ipsum`) на наличие сообщений об успешном обновлении или ошибках.
