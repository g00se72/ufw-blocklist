# UFW Blocklist: Расширение для блокировки IP-адресов и CIDR
Данный репозиторий - это моя версия на основе репозитория от уважаемого [poddmo](https://github.com/poddmo/ufw-blocklist)

> [!WARNING]
>   
> ***Реализация сделана исключительно для себя, в научно-технических целях. Т.к. пишу и тестирую сам, то возможно мне удается проверить не все возможные сценарии использования. Если Вы решите использовать эти скрипты в своей системе, Вы делаете это полностью на свой страх и риск. Я не несу никакой ответственности за любые прямые или косвенные последствия их использования. Вся ответственность за любые результаты, проблемы или ущерб, возникшие в результате использования, ложится исключительно на Вас. Перед использованием убедительно рекомендуется внимательно изучить код и адаптировать его под свои нужды и условия***

Протестировано мной на Ubuntu 22.04.5 LTS(jammy) и Ubuntu 20.04.6 LTS(focal)

## Описание
Проект предоставляет набор скриптов для интеграции динамических списков блокировки IP-адресов и CIDR с файрволом UFW (Uncomplicated Firewall) в Ubuntu. Используя `ipset`, скрипты позволяют эффективно блокировать большие объемы вредоносного трафика на уровне ядра.
Проект состоит из нескольких компонентов, работающих вместе для управления списками блокировки:

1. **`/etc/ufw/after.init`**: Основной скрипт, который запускается UFW после своей инициализации. Он действует как "раннер", выполняя все скрипты, расположенные в директории `/etc/ufw/after.init.d/`. Это обеспечивает модульность и позволяет легко добавлять или удалять различные списки блокировки.

2. **`/etc/ufw/after.init.d/`**: Директория, содержащая исполняемые скрипты, которые выполняются основным скриптом `after.init`. Каждый скрипт в этой директории может отвечать за инициализацию отдельного списка блокировки или белого списка (`ipset`) и настройку соответствующих правил `iptables`. Скрипты именуются с числовым префиксом (например, `05-`, `10-`, `20-`) для контроля порядка выполнения.\
Примечание: скрипт создания `ipset` белого списка должен выполняться раньше остальных, таким образом если нужный IP-адрес случайным образом окажется в списке блокировок он будет проигнорирован, так будет исполнятся позднее (правила применяются сверху-вниз)

3. **`/etc/cron.daily/ufw-blocklist<Index>-update`**: Скрипты для ежедневного обновления списков блокировки. Они скачивают актуальные списки из внешних источников (например, из проекта [ipsum](https://github.com/stamparm/ipsum/tree/master)), валидируют их и атомарно обновляют соответствующие `ipset` без прерывания работы файрвола.

4. **`/etc/default/ufw-blocklist`**: Централизованный конфигурационный файл, содержащий общие настройки для всех скриптов проекта, такие как пути к исполняемым файлам (`ipset`), настройки журналирования, регулярные выражения для валидации CIDR и параметры по умолчанию для списков блокировки.

## Возможности

* **Эффективная блокировка:** Использование `ipset` позволяет блокировать тысячи и миллионы IP-адресов/CIDR с минимальной нагрузкой на систему.

* **Модульность:** Легкое добавление поддержки новых списков блокировки путем создания новых скриптов в `/etc/ufw/after.init.d/` и `/etc/cron.daily/`.

* **Автоматическое обновление:** Ежедневное обновление списков блокировки через cron.

* **Централизованная конфигурация:** Удобное управление основными параметрами через единый файл.

* **Надежная валидация:** Проверка записей на соответствие формату CIDR перед добавлением в `ipset`.

* **Совместимость с UFW:** Бесшовная интеграция с механизмом `after.init` файрвола UFW.

## Установка

Предполагается, что у вас уже установлены `ipset`, `iptables`, `curl`, `logger`, `stat`, `grep`, `mktemp`, `run-parts`, `cut`, `tail`, `journalctl`

1. Создайте бэкап оригинального `after.init` скрипта UFW
   ```bash
   sudo cp /etc/ufw/after.init /etc/ufw/after.init.orig
   ```

2. **Скопируйте файлы на свои места:**
   ```bash
   sudo mkdir -p /etc/ufw/after.init.d
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/ufw-blocklist' -o /etc/default/ufw-blocklist
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/after.init' -o /etc/ufw/after.init
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/05-ufw-whitelist.ufw' -o /etc/ufw/after.init.d/05-ufw-whitelist.ufw
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/10-ufw-blocklist1.ufw' -o /etc/ufw/after.init.d/10-ufw-blocklist1.ufw
   ```
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/g00se72/ufw-blocklist/main/ufw-blocklist1-update' -o /etc/cron.daily/ufw-blocklist1-update
   ```
   
3. **Сделайте скрипты исполняемыми:**
   ```bash
   sudo chmod +x /etc/ufw/after.init
   ```
   ```bash
   sudo chmod +x /etc/ufw/after.init.d/10-ufw-blocklist1.ufw
   ```
   ```bash
   sudo chmod +x /etc/cron.daily/ufw-blocklist1-update
   ```
   ```bash
   sudo chmod +x /etc/ufw/after.init.d/05-ufw-whitelist.ufw
   ```
   
4. **Создайте начальные файлы со списком блокировок:**
   
   Скрипт `10-ufw-blocklist1.ufw` при запуске UFW пытается загрузить начальный список из файла, указанного в `UFBL_SEED_FILE<Index>`. Вы можете создать этот файл вручную или скачать список командой:
   ```bash
   sudo curl -sS -f --compressed 'https://raw.githubusercontent.com/stamparm/ipsum/master/levels/3.txt' -o /etc/ufw/ufw-blocklist1.txt
   ```
   ```bash
   sudo chown root:root /etc/ufw/ufw-blocklist1.txt && sudo chmod 600 /etc/ufw/ufw-blocklist1.txt
   ```
   Примечание: Убедитесь, что URL соответствует вашим потребностям. Этот файл используется только для начального заполнения `ipset` при старте UFW. Ежедневное обновление будет использовать URL, указанный в конфигурационном файле.

6. **Создайте начальный файл с белым списком:**  

   Скрипт `05-ufw-whitelist.ufw` при запуске UFW пытается загрузить начальный список из файла, указанного в `UFBL_WHITELIST_FILE`. Вы можете создать и заполнить этот файл вручную любым способом:
   ```bash
   echo -e "192.168.1.100\n10.0.0.0/8\n203.0.113.50" > /etc/ufw/ufw-whitelist.txt && sudo chown root:root /etc/ufw/ufw-whitelist.txt && chmod 600 /etc/ufw/ufw-whitelist.txt
   ```
<details>
<summary>Пример содержимого</summary>
    
> 192.168.1.100\
> 10.0.0.0/8\
> 203.0.113.50

</details>

7. **Перезапустите UFW:**
   ```bash
   sudo systemctl restart ufw
   ```
   Это запустит скрипт `/etc/ufw/after.init`, который в свою очередь запустит скрипты из `/etc/ufw/after.init.d/`, включая `05-ufw-whitelist.ufw` и `10-ufw-blocklist1.ufw`. Скрипт `05-ufw-whitelist.ufw` создаст `ipset` и добавит в него записи из `/etc/ufw/ufw-whitelist.txt`, а также настроит правила `iptables`. Скрипт `10-ufw-blocklist1.ufw` создаст `ipset` и добавит в него записи из `/etc/ufw/ufw-blocklist1.txt`, а также настроит правила `iptables`.

## Конфигурация
Основной файл конфигурации находится по адресу `/etc/default/ufw-blocklist`. Вы можете редактировать его для изменения следующих параметров:
* `UFBL_IPSET_BIN`: Путь к исполняемому файлу `ipset`
* `UFBL_LOGGER_BIN`: Путь к исполняемому файлу `logger`
* `UFBL_IPSET_NAME<Index>`: Имя `ipset` для списка блокировок
* `UFBL_SEED_FILE<Index>`: Путь к файлу начального заполнения списков блокировок
* `UFBL_DEFAULT_MAXELEM_HEADROOM`: Дополнительное место в `ipset` сверх количества записей в списке
* `UFBL_URL<Index>`: URL для скачивания списка блокировки `ipsum` (используется скриптом обновления)
* `UFBL_MIN_ENTRIES<Index>`: Минимальное ожидаемое количество записей в списке `ipsum`
* `UFBL_WARN_ON_NO_CHANGE<Index>`: Включает/отключает предупреждение, если количество записей не изменилось (`yes`/`no`)
* `UFBL_CIDR_REGEX`: Регулярное выражение для валидации записей как CIDR (IPv4)
* `UFBL_ENABLE_IP_ROUTE_VALIDATION`: Включить проверку с использованием системной команды ip route get. При включении каждая запись из списка будет проверяться перед добавлением в ipset
* `UFBL_WHITELIST_IPSET_NAME`: Имя `ipset` для белого списка
* `UFBL_WHITELIST_FILE`: Путь к файлу белого списка
* `UFBL_WHITELIST_MAXELEM_HEADROOM`: Дополнительное место в `ipset` сверх количества записей в списке
* `UFBL_WHITELIST_ONLY_<*>`: Работа только по белому листу, запретить остальной трафик. Используйте эту функцию с осторожностью, проверьте внимательно адреса, которые у вас добавлены в белый список, так как можете потерять доступ к своему серверу.

**Для добавления поддержки нового списка блокировок:**
1. Создайте новый скрипт в `/etc/ufw/after.init.d/` (например, `20-myotherlist.ufw`), который будет создавать и наполнять соответствующий `ipset` и добавлять правила `iptables`. Этот скрипт должен использовать функции и переменные из `/etc/default/ufw-blocklist`.
2. Создайте соответствующий скрипт ежедневного обновления для него в `/etc/cron.daily/` (например, `ufw-blocklist-myotherlist-update`), который будет скачивать и обновлять новый `ipset`.
3. При необходимости добавьте специфические параметры для нового списка в `/etc/default/ufw-blocklist` или переопределите их в скриптах нового списка.

## Использование
После установки и настройки система работает автоматически. Однако вы можете использовать команды для получения статуса или сброса счетчиков:
* **Получение статуса:** Выполните команду, которая запустит скрипты `status` из `/etc/ufw/after.init.d/`. Обычно это делается через команду, связанную с UFW, или путем прямого вызова основного скрипта `after.init` (хотя прямое взаимодействие с `after.init` не всегда рекомендуется, так как он предназначен для вызова UFW).\
Более надежный способ получить статус конкретного списка (например, `ipsum`) - это посмотреть логи или использовать команды `ipset` и `iptables` напрямую, как это делает скрипт `10-ufw-blocklist1.ufw` в своем блоке `status`.

> [!NOTE]
> Пример просмотра статуса `ipset` и правил для `ipsum`:\
> `sudo ipset list ufw-blocklist1 -t`\
> `sudo iptables -L -nvx | grep ufw-blocklist1`\
> `sudo journalctl -t ufw-blocklist1 | tail`
> 
> Примечание: Команда `sudo /etc/ufw/after.init status` может работать, но ее основное назначение - быть вызванной UFW.

* **Сброс счетчиков (flush-all):** Чтобы сбросить счетчики пакетов в правилах `iptables` и очистить содержимое `ipset` (без его удаления), вы можете вызвать соответствующую команду. Опять же, это действие обычно инициируется через UFW или может быть выполнено вызовом скрипта в `/etc/ufw/after.init.d/` напрямую с аргументом `flush-all`.

> [!NOTE]
> Пример вызова `flush-all` для `ipsum`:\
> `sudo /etc/ufw/after.init.d/10-ufw-blocklist1.ufw flush-all`

Будьте осторожны с прямым вызовом скриптов в `after.init.d/` и основного `after.init`. Их основное предназначение - быть частью жизненного цикла UFW.

Ежедневное обновление списка `ipsum` происходит автоматически через cron. Вы можете проверить логи (`journalctl -t ufw-blocklist1`) на наличие сообщений об успешном обновлении или ошибках.
